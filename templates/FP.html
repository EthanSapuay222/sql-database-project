{% extends 'base.html' %}

{% block title %}EcoTrack Home{% endblock %}

{% block head %}
<script>
  tailwind.config = {
    theme: {
      extend: {
        colors: {
          "image-bg": "#FFFBF0",
          "image-header-bg": "#A0B0A0",
          "image-sidebar-bg": "#A0B0A0",
          "footer-brown": "#B86E28",
          "button-main-bg": "#6B8E23",
          "button-main-hover": "#556B2F",
          "image-text-light": "#FFFFFF",
          "image-text-dark": "#36454F",
          "image-link-text": "#FFFFFF",
          "image-logo-bg": "#6B8E23",
          "map-border": "#6B8E23",
        },
      },
    },
  };
</script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/FP.css') }}" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/map.css') }}" />
{% endblock %}

{% block content %}
<div id="app-container" class="min-h-screen flex flex-col">
  <header class="bg-image-header-bg p-4 flex justify-between items-center shadow-lg">
    <div class="flex items-center space-x-3">
      <div class="bg-image-logo-bg w-10 h-10 rounded-full flex items-center justify-center border-2 border-white">
        <img src="{{ url_for('static', filename='img/EcotrackLogo.png') }}" class="w-full h-full object-cover rounded-full" alt="EcoTrack Logo" />
      </div>
      <span class="text-image-text-dark font-extrabold text-2xl tracking-wider">EcoTrack</span>
    </div>
    <div>
      <a href="{{ url_for('auth.logout') }}" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold transition duration-150">Logout</a>
    </div>
  </header>

  <div class="flex flex-1">
    <nav id="sidebar-nav" class="w-64 bg-image-sidebar-bg p-4 flex flex-col space-y-2 shadow-xl hidden md:flex">
      <ul class="space-y-2">
        <li>
          <a href="{{ url_for('pages.species_view') }}" class="bg-button-main-bg text-image-text-light p-3 flex items-center rounded-lg hover:bg-button-main-hover transition duration-150 font-medium shadow-md">
            <span class="text-xl mr-2">‚Üí</span> View Life on Land & Water
          </a>
        </li>
        <li>
          <a href="{{ url_for('pages.dashboard_view') }}" class="bg-button-main-bg text-image-text-light p-3 flex items-center rounded-lg hover:bg-button-main-hover transition duration-150 font-medium shadow-md">
            <span class="text-xl mr-2">‚Üí</span> Environmental Dashboard
          </a>
        </li>
        <li>
          <a href="{{ url_for('pages.submission_report_view') }}" class="bg-button-main-bg text-image-text-light p-3 flex items-center rounded-lg hover:bg-button-main-hover transition duration-150 font-medium shadow-md">
            <span class="text-xl mr-2">‚Üí</span> Submission Report
          </a>
        </li>
        <li>
          <a href="{{ url_for('pages.map_view') }}" class="bg-button-main-bg text-image-text-light p-3 flex items-center rounded-lg hover:bg-button-main-hover transition duration-150 font-medium shadow-md" target="_blank" rel="noopener noreferrer">
            <span class="text-xl mr-2">‚Üí</span> Interactive Map
          </a>
        </li>
        <li>
          <a href="{{ url_for('pages.about_view') }}" class="bg-button-main-bg text-image-text-light p-3 flex items-center rounded-lg hover:bg-button-main-hover transition duration-150 font-medium shadow-md">
            <span class="text-xl mr-2">‚Üí</span> About Us
          </a>
        </li>
      </ul>
    </nav>

    <main id="main-content" class="flex-1 p-8">
      <div class="text-center">
        <h2 class="text-2xl font-semibold italic text-image-text-dark mb-2">"Track Change, Make Impact"</h2>
        <p class="text-lg text-image-text-dark font-medium mb-16">Environmental Awareness & Progress Tracker for Batangas</p>
      </div>
      <div class="bg-green-700 p-8 rounded-lg shadow-lg mb-8 text-white max-w-4xl mx-auto">
        <h3 class="text-2xl font-semibold mb-4">SDG 14: Life Below Water</h3>
        <p class="text-lg leading-relaxed">Healthy oceans and seas are essential to our existence. They cover 70 percent of our planet and we rely on them for food, energy and water. Yet, we have managed to do tremendous damage to these precious resources. We must protect them by eliminating pollution and overfishing and immediately start to responsibly manage and protect all marine life around the world.</p>
      </div>

      <div class="bg-green-700 p-8 rounded-lg shadow-lg text-white max-w-4xl mx-auto">
        <h3 class="text-2xl font-semibold mb-4">SDG 15: Life On Land</h3>
        <p class="text-lg leading-relaxed">A flourishing life on land is the foundation for our life on this planet. We are all part of the planet's ecosystem and we have caused severe damage to it through deforestation, loss of natural habitats and land degradation. Promoting a sustainable use of our ecosystems and preserving biodiversity is not a cause. It is the key to our own survival.</p>
      </div>
    </main>
  </div>

  <section class="p-8 border-t border-map-border bg-image-bg">
    <div class="container mx-auto flex flex-col items-center">
      <h3 class="text-2xl font-bold mb-4 text-image-sidebar-bg">Environmental Reports Across Batangas (Map Preview)</h3>
      <div id="fp-map-container" class="w-full max-w-4xl h-96 border-4 border-map-border rounded-xl overflow-hidden shadow-lg"></div>
      <a href="{{ url_for('pages.map_view') }}" class="mt-6 inline-block">
        <button type="button" class="bg-button-main-bg text-white px-8 py-3 rounded-full text-lg font-semibold shadow-md hover:bg-button-main-hover transition duration-150">View Full Map</button>
      </a>
    </div>
  </section>

  <footer class="bg-footer-brown text-white py-10 w-full">
    <div class="container mx-auto flex flex-col items-center text-center space-y-4">
      <div class="flex items-center space-x-2">
        <div class="bg-teal-400 rounded-full p-1">
          <img src="{{ url_for('static', filename='img/EcotrackLogo.png') }}" alt="EcoTrack" class="w-8 h-8 rounded-full object-cover" />
        </div>
        <span class="text-2xl font-bold">EcoTrack</span>
      </div>
      <h2 class="text-xl font-bold italic">"Track Change, Make Impact"</h2>
      <div class="text-sm space-y-1">
        <p>&copy; 2025 Group 5 ‚Äì DBMS & Advance Computer Programing School Project</p>
        <p class="font-bold">Created by: Sapuay | Semira | Caguimbal | De Chavez</p>
      </div>
      <a href="{{ url_for('pages.resources_view') }}" class="text-white italic hover:underline flex items-center font-semibold mt-4">
        Resources & Credits
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" class="w-5 h-5 ml-2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
        </svg>
      </a>
    </div>
  </footer>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
(function() {
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMap);
  } else {
    initMap();
  }

  function initMap() {
    var mapContainer = document.getElementById('fp-map-container');
    if (!mapContainer) {
      console.log('FP Map: Container not found');
      return;
    }

    console.log('FP Map: Initializing...');

    var SEVERITY_COLORS = {
      Low: '#4CAF50',
      Medium: '#FF9800',
      High: '#F44336',
      Critical: '#D92D2D'
    };

    var SEVERITY_ICONS = {
      Low: 'üü¢',
      Medium: 'üü†',
      High: 'üî¥',
      Critical: '‚ö†Ô∏è'
    };

    var fpMap = L.map('fp-map-container').setView([13.8595, 120.978], 10);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(fpMap);

    function calculateSeverity(reports) {
      if (!reports || reports.length === 0) return 'Low';
      
      var weights = { Critical: 4, High: 3, Medium: 2, Low: 1 };
      var total = 0;
      for (var i = 0; i < reports.length; i++) {
        total += (weights[reports[i].severity] || 1);
      }
      var avg = total / reports.length;
      
      if (avg >= 3.5) return 'Critical';
      if (avg >= 2.5) return 'High';
      if (avg >= 1.5) return 'Medium';
      return 'Low';
    }

    // Fetch locations and reports
    Promise.all([
      fetch('/api/locations').then(function(r) { return r.json(); }),
      fetch('/api/reports').then(function(r) { return r.json(); })
    ])
    .then(function(results) {
      var locations = results[0];
      var reports = results[1];
      
      console.log('FP Map: Locations loaded:', locations.data ? locations.data.length : 0);
      console.log('FP Map: Reports loaded:', reports.data ? reports.data.length : 0);

      if (!locations.success || !locations.data) {
        console.log('FP Map: No location data');
        return;
      }

      // Group reports by location_id
      var reportsByLoc = {};
      if (reports.success && reports.data) {
        for (var i = 0; i < reports.data.length; i++) {
          var r = reports.data[i];
          var locId = r.location ? r.location.location_id : null;
          if (locId) {
            if (!reportsByLoc[locId]) reportsByLoc[locId] = [];
            reportsByLoc[locId].push(r);
          }
        }
      }

      console.log('FP Map: Reports grouped by location:', Object.keys(reportsByLoc).length, 'locations have reports');

      // Add markers
      for (var j = 0; j < locations.data.length; j++) {
        var loc = locations.data[j];
        if (!loc.latitude || !loc.longitude) continue;

        var lat = parseFloat(loc.latitude);
        var lon = parseFloat(loc.longitude);
        if (isNaN(lat) || isNaN(lon)) continue;

        var locReports = reportsByLoc[loc.location_id] || [];
        var severity = calculateSeverity(locReports);
        var color = SEVERITY_COLORS[severity];
        var icon = SEVERITY_ICONS[severity];

        var pinHtml = '<div style="width:24px;height:24px;border-radius:50%;background-color:' + color + ';border:2px solid white;box-shadow:0 2px 5px rgba(0,0,0,0.3);"></div>';

        var markerIcon = L.divIcon({
          className: '',
          html: pinHtml,
          iconSize: [24, 24],
          iconAnchor: [12, 24],
          popupAnchor: [0, -20]
        });

        var popup = '<div style="padding:8px;">' +
          '<h4 style="font-weight:bold;font-size:16px;margin:0 0 4px 0;">' + loc.city_name + '</h4>' +
          '<p style="font-size:12px;color:#666;margin:0 0 8px 0;border-bottom:1px solid #eee;padding-bottom:4px;">Batangas Province</p>' +
          '<p style="font-size:14px;margin:4px 0;">Total Reports: <strong>' + locReports.length + '</strong></p>' +
          '<p style="font-size:14px;margin:4px 0;">Severity: <strong style="color:' + color + ';">' + icon + ' ' + severity + '</strong></p>' +
          '</div>';

        L.marker([lat, lon], { icon: markerIcon })
          .bindPopup(popup)
          .addTo(fpMap);
      }

      console.log('FP Map: Markers added');
    })
    .catch(function(err) {
      console.error('FP Map Error:', err);
    });
  }
})();
</script>
{% endblock %}
